以太网传输视频：

    tpg  -> vdma -> zynq -> lwip -> 上位机
两路tpg分辨率为640*720 60fps
参考黑金 双目摄像头以太网传输

上位机实时显示目前单个视频流帧率可稳定到30fps，上位机未作两个图像拼接

BUG：
    1、上位机被拖动，视频显示有问题
    2、一旦分辨率增大，帧率会受影响？未测试

---

# memory access and msg access framework

---

## udp_logic

basic class open a udp socket and bind to port, then create a thread to recieve

---

## cmd

| msg_cmd        | sub_msg                              | function                              |

| -------------- | ------------------------------------ | ------------------------------------- |

| 0x10           | NA                                   | read mem of a given addr              |

| 0x11           | NA                                   | write mem of a given addr             |

| 0x12           | NA                                   | read mem bulk(max 200~ words, fixme)  |

| 0x13           | NA                                   | write mem bulk(max 200~ words, fixme) |

| 0x40 (var_ops) | 0x0001(0x01 0x11)                    | read firmware version (elf ver)       |

| 0x20 (TODO)    | NA                                   | i2c read                              |

| 0x21 (TODO)    | NA                                   | i2c write                             |

| 0x22 (TODO)    | NA                                   | i2c status query                      |

| 0x30 (TODO)    | NA                                   | spi access                            |

|                |                                      |                                       |

|                |                                      |                                       |

|                |                                      |                                       |

| 0x80           | 0x01 / 0x02(Number of video sources) | Request to send image data            |

|                |                                      |                                       |

---

## protocol

###1. 协议说明

####1.1 约定一条消息指一条完整的数据包，以消息代码区分；

####1.2 协议中用到的数据类型列表如下：

缩写 说明

Int8 带符号 8 位整型

Int16 带符号 16 位整型

Int32 带符号 32 位整型

Int64 带符号 64 位整型

uInt8 无符号 8 位整型

uInt16 无符号 16 位整型

uInt32 无符号 32 位整型

uInt64 无符号 64 位整型

Real32 单精度浮点 (32bit)

Real64 双精度浮点 (64bit)

Char 字符型

[n] 数组类型,n字节

协议中的数值型数据如无特别说明，均采用**小端模式**，即低字节在前；

####1.3 消息的组成

#####1.3.1 消息结构

消息长(uInt16) 全部长度，字节为单位

预留段(uInt16) 协议版本、设备 ID等, 先预留16bit

消息代码(uInt8) 即读(0x10)，写(0x11)，块读(0x12)，块写(0x13)等命令，按照特点格式组织消息体

消息体

数据段

校验和(uInt8)  除校验和外消息其它字节的累加取反

#####1.3.2 应答消息

消息长(uInt16) 全部长度，字节为单位

预留段(uInt16) 协议版本、设备 ID等, 先预留16bit

消息代码

消息体

数据段

校验和

###2. 通信协议的基本功能定义

####2.1 单内存地址读写

#####例如 读 地址0x07200000

PC向服务器发出

| 消息长    | 预留段    | 消息代码 | 消息体                                  | 校验和 |

| --------- | --------- | -------- | --------------------------------------- | ------ |

| 0x0E 0x00 | 0x00 0x00 | 0x10     | 0x00 0x00 0x20 0x07 0x00 0x00 0x00 0x00 | 0xBA   |

服务器应答

| 消息长    | 预留段    | 消息代码 | 消息体                                  | 校验和 |

| --------- | --------- | -------- | --------------------------------------- | ------ |

| 0x0E 0x00 | 0x00 0x00 | 0x10     | 0x00 0x00 0x20 0x07 0x75 0xba 0x26 0x11 | 0x54   |

#####写 数据0x12345678 到 地址0x07200000

PC向服务器发出

| 消息长    | 预留段    | 消息代码 | 消息体                                  | 校验和 |

| --------- | --------- | -------- | --------------------------------------- | ------ |

| 0x0E 0x00 | 0x00 0x00 | 0x11     | 0x00 0x00 0x20 0x07 0x78 0x56 0x34 0x12 | 0xA5   |

服务器应答

| 消息长    | 预留段    | 消息代码 | 消息体(地址+实际读值)                   | 校验和 |

| --------- | --------- | -------- | --------------------------------------- | ------ |

| 0x0E 0x00 | 0x00 0x00 | 0x11     | 0x00 0x00 0x20 0x07 0x78 0x56 0x34 0x12 | 0xA5   |

* 
* 消息长		 预留段		 消息代码		通道标识		控制段
  0x00 0x07	 0x00 0x00	 0x80		   0x01 		  0x01

其中通道标识为摄像头通道选择，数值1代表仅打开摄像头1，数值2代表仅打开摄像头2，数值3代表同时打开两个摄像头，以此类推

在通道

其中控制段为启动信号，0表示关闭上位图像显示，1表示只传输一帧图片，2表示传输视频流

    服务器应答

    消息长度           预留段                  应答代码          通道标识           序列号       	   图像数据

    0x?? 0x??	    0x00 0x00	        0x81		0x01 		0x?? 0x?? 0x??    N*bytes

    序列号代表以太网包序号，用于上位机识别，一副图像拆分成多次传输
